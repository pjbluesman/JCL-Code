SELECT CHAR(SUBSTR(A.DS_GRP, 1, 4)) AS DS_GRP,
 CHAR(' '),
 A.DBNAME,
 CHAR(' '),
 A.OBJ_NAME,
 CHAR(' '),
 CHAR(A.OBJ_TYPE),
 CHAR(' '),
 CHAR(A.DSNUM) AS DSNUM,
 CHAR(' '),
 CHAR(DEC(VALUE(
 DEC(DEC(DEC(A.TRKS_ALLOC)/DEC(A.MAX_TRACKS),5,4)*100,5,2),0),5,2))
 AS PERCENT_ALLOC,
 CHAR(' '),
 CHAR(A.MAX_TRACKS),
 CHAR(' '),
 CHAR(A.TRKS_ALLOC),
 CHAR(A.TRKS_USED) AS TRKS_USED,
 CHAR(A.TRKS_AVAIL),
 CHAR(A.ALLOC_TYPE),
 CHAR(' '),
 CHAR(IFNULL(B.TRKS_USED, - 1)) AS USED_7,
 CHAR(IFNULL(C.TRKS_USED, - 1)) AS USED_14,
 CHAR(IFNULL(D.TRKS_USED, - 1)) AS USED_21,
 CHAR(IFNULL(A.TRKS_USED - D.TRKS_USED, - 1)) AS THREE_WEEK_INCREASE,
 A.RPT_TMSTP,
 CHAR(' '),
 CHAR(A.HLQ),
 CHAR(' '),
 CHAR(A.EXTENTS),
 CHAR(A.PGSIZE),
 CHAR(A.DB2_PQTY),
 CHAR(A.DB2_SQTY),
 CHAR(' '),
 CHAR(A.TS_TYPE),
 CHAR(' '),
 CHAR(A.DSSIZE_G),
 CHAR(' '),
 CHAR(A.MAXPARTITONS)
FROM (
    SELECT CHAR(VCATNAME) AS HLQ,
     SUBSTR(A.DBNAME, 1, 9) AS DBNAME,
    SUBSTR(OBJ_NAME, 1, 9) AS OBJ_NAME,
    OBJ_TYPE,
    TS_TYPE, A.DSNUM, CHAR(DSNUM) AS DSNUM2, DS_GRP,
    CHAR(EXTENTS) AS EXTENTS,   CHAR(A.PGSIZE)  AS PGSIZE,
    CHAR(DB2_PQTY) AS DB2_PQTY, CHAR(DB2_SQTY)  AS DB2_SQTY,
    CHAR(TRKS_ALLOC) AS TRKS_ALLOC, TRKS_USED,
    CHAR(TRKS_USED) AS TRKS_USEDC, CHAR(TRKS_AVAIL) AS TRKS_AVAIL,
    CHAR(ALLOC_TYPE) AS ALLOC_TYPE,
    RPT_TMSTP,CHAR(A.MAXPARTITIONS) AS MAXPARTITONS,
      CHAR(VALUE(
       CASE DSSIZE_PIECESIZE WHEN 0 THEN INT(2)
       ELSE  INT(DSSIZE_PIECESIZE/ 1024 / 1024)
       END,INT(0)))    AS DSSIZE_G,
    CHAR(VALUE(
     CASE DSSIZE_PIECESIZE WHEN 0
      THEN INT(43695)   ELSE INT(INT(DSSIZE_PIECESIZE
      / 1024 / 1024 / 2) * 43695) END,INT(0))) AS "MAX_TRACKS"
   ,TS.TYPE, IXS.TYPE AS IXTYPE , IXS.MAXPARTITIONS AS IXSMAXPARTITIONS
   ,IXS.PARTITIONS AS IXSPARTITIONS
    FROM @DBA.DB2_OBJ_SPACE_DTL A
        LEFT OUTER JOIN SYSIBM.SYSTABLESPACE TS
        ON A.DBNAME = TS.DBNAME
        AND A.OBJ_NAME = TS.NAME
        LEFT OUTER JOIN
       (SELECT I.DBNAME, I.INDEXSPACE AS NAME, TS.TYPE, TS.MAXPARTITIONS
              , TS.PARTITIONS
        FROM SYSIBM.SYSINDEXES I, SYSIBM.SYSTABLES T,
             SYSIBM.SYSTABLESPACE TS
         WHERE I.TBCREATOR = T.CREATOR
         AND I.TBNAME = T.NAME
         AND T.DBNAME = TS.DBNAME
         AND T.TSNAME = TS.NAME
        ) IXS
        ON A.DBNAME = IXS.DBNAME
        AND A.OBJ_NAME = IXS.NAME
    WHERE TS_TYPE <> 'P' AND DSNUM > 19
    AND ((TS.TYPE = ' ' AND DSNUM > 19)
    OR (TS.TYPE = 'G' AND DSNUM / A.MAXPARTITIONS >.59)
    OR (TS.TYPE IS NULL AND IXS.TYPE <> 'G')
    OR (TS.TYPE IS NULL AND IXS.TYPE = 'G' AND DSNUM /IXS.MAXPARTITIONS
    >.59)  )
AND A.DS_GRP = 'DSN'
AND DSNUM = (
        SELECT MAX(B.DSNUM)
        FROM @DBA.DB2_OBJ_SPACE_DTL B
        WHERE A.VCATNAME = B.VCATNAME
        AND A.DBNAME = B.DBNAME AND A.OBJ_NAME =
             B.OBJ_NAME AND A.OBJ_TYPE = B.OBJ_TYPE AND A.RPT_TMSTP =
             B.RPT_TMSTP) AND RPT_TMSTP > (
        SELECT MAX(RPT_TMSTP) - 24 HOURS
        FROM @DBA.DB2_OBJ_SPACE_DTL B)
        AND A.DBNAME NOT LIKE '%DB07') A
LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL B
ON A.DBNAME = B.DBNAME AND A.OBJ_NAME = B.OBJ_NAME
AND A.DSNUM = B.DSNUM AND
     B.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 7 DAYS
     AND A.RPT_TMSTP + 5     HOURS - 7 DAYS
LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL C
ON A.DBNAME = C.DBNAME AND A.OBJ_NAME = C.OBJ_NAME
AND A.DSNUM = C.DSNUM AND
     C.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 14 DAYS
     AND A.RPT_TMSTP + 5     HOURS - 14 DAYS
LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL D
ON A.DBNAME = D.DBNAME AND A.OBJ_NAME = D.OBJ_NAME
AND A.DSNUM = D.DSNUM AND
     D.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 21 DAYS
      AND A.RPT_TMSTP + 5     HOURS - 21 DAYS
ORDER BY A.DS_GRP, A.DSNUM DESC, A.TRKS_USED DESC
WITH UR;
