-- IF ROWS ARE RETURNED IMAGE COPY THE OBJECT AND NOTIFY THE TEAM ON
-- MONDAY MORNING CALL.   ASSIGNMENT WILL BE MADE TO FIX IC_CONTROL
-- TO MAKE SURE OBJECT IS BEING COPIED DAILY.
--
WITH
BASE1 (DBNAME, TSNAME, PARTITION, LAST_COPY_DT) AS
      (SELECT DBNAME, NAME, PARTITION, MAX(DATE(COPYLASTTIME))
         FROM SYSIBM.SYSTABLESPACESTATS CPY
        WHERE CPY.COPYLASTTIME > CURRENT TIMESTAMP - 7 DAYS
          AND NAME NOT LIKE 'DSN32K%'  -- TEMP SPACE NOT COPIED
          AND NAME NOT LIKE 'DSN4K%'
        GROUP BY DBNAME, NAME, PARTITION)
,COPY_SEARCH (DBNAME,TSNAME, PARTITION,LAST_COPY_DT) AS
              (SELECT DISTINCT  * FROM
                   (SELECT   *
                    FROM BASE1 CPY
                UNION
                    SELECT  DBNAME, TSNAME ,DSNUM ,
                            MAX(DATE(IC.TIMESTAMP))
                    FROM SYSIBM.SYSCOPY     IC
                    WHERE IC.ICTYPE ='F'
                    AND DBNAME LIKE 'DSN%'
                    AND TSNAME NOT LIKE 'DSN32K%' -- TEMP SPACE NOT COPY
                    AND TSNAME NOT LIKE 'DSN4K%'
                    AND IC.TIMESTAMP > CURRENT TIMESTAMP  - 7 DAYS
                    AND (DBNAME, TSNAME) NOT IN
                        (SELECT DBNAME, TSNAME
                           FROM BASE1 CPY
                          WHERE DBNAME LIKE 'DSN%')
                    GROUP BY DBNAME, TSNAME ,DSNUM
                  ) A
                ORDER BY 1,2,3)
SELECT DISTINCT LEFT(P.DBNAME,8 ) DBNAME,
       LEFT(P.TSNAME,8) TSNAME, S.LAST_COPY_DT,
       LEFT(T.NAME,20) TABLE , LEFT(T.CREATOR,10) CREATOR
FROM SYSIBM.SYSTABLEPART P
LEFT OUTER JOIN     (SELECT   DBNAME, NAME, PARTITION,
                              MAX(DATE(COPYLASTTIME))  AS LAST_COPY_DT
                       FROM SYSIBM.SYSTABLESPACESTATS CPY
                      GROUP BY DBNAME, NAME, PARTITION)S
   ON  P.DBNAME = S.DBNAME
   AND P.TSNAME = S.NAME
   AND P.PARTITION = S.PARTITION
, SYSIBM.SYSTABLES T --
WHERE (P.DBNAME, P.TSNAME, P.PARTITION)  NOT IN
                 (SELECT  DBNAME , TSNAME,PARTITION
                     FROM COPY_SEARCH
                   )
AND P.TSNAME NOT LIKE 'DSN32K%'  -- TEMP SPACE NOT COPIED ON PURPOSE.
AND P.TSNAME NOT LIKE 'DSN4K%'
AND P.DBNAME = T.DBNAME
AND P.TSNAME = T.TSNAME
AND T.TYPE NOT IN ('A','V')
