SELECT CHAR(SUBSTR(A.DS_GRP, 1, 4)) AS DS_GRP,
CHAR(' '),
CHAR(A.VCATNAME) AS HLQ,CHAR(' '),
SUBSTR(A.DBNAME,1,9),CHAR(' '),SUBSTR(A.OBJ_NAME,1,9),CHAR(' '),
A.OBJ_TYPE,CHAR(' '), A.TS_TYPE,CHAR(' '),
CHAR (A.DSNUM) AS DSNUM,CHAR(' '),
 CHAR (A.EXTENTS) AS EXTENTS ,CHAR(' '),
 CHAR (A.PGSIZE) AS PGSIZE,CHAR(' '),
 CHAR (A.DB2_PQTY) AS DB2_PQTY  ,CHAR(' '),
 CHAR (A.DB2_SQTY) AS DB2_SQTY,CHAR(' '),
 CHAR (A.TRKS_ALLOC) AS TRKS_ALLOC ,CHAR(' '),
 CHAR (A.TRKS_USED) AS TRKS_USED,CHAR(' '),
 CHAR (A.TRKS_AVAIL) AS TRKS_AVAIL,CHAR(' '),
 CHAR (A.ALLOC_TYPE) AS ALLOC_TYPE ,CHAR(' '),
 A.RPT_TMSTP ,CHAR(' '),
CHAR(B.TRKS_USED) AS USED_7,CHAR(' '),
CHAR(C.TRKS_USED) AS USED_14,CHAR(' '),
CHAR(D.TRKS_USED) AS USED_21,CHAR(' '),
CHAR(A.TRKS_USED -D.TRKS_USED)  AS THREE_WEEK_INCREASE
FROM (
SELECT
DS_GRP,
A.VCATNAME,
A.DBNAME,A.OBJ_NAME,
OBJ_TYPE,TS_TYPE,
DSNUM,
EXTENTS,
 PGSIZE,
 DB2_PQTY,
 DB2_SQTY,
 TRKS_ALLOC,
 TRKS_USED,
 TRKS_AVAIL,
 ALLOC_TYPE,
 RPT_TMSTP
 FROM @DBA.DB2_OBJ_SPACE_DTL A
 WHERE ALLOC_TYPE IN ('VCAT')
 AND  (RPT_TMSTP) >  (SELECT MAX(RPT_TMSTP)  - 24 HOURS
             FROM @DBA.DB2_OBJ_SPACE_DTL B1)
 AND DSNUM = (SELECT MAX(B.DSNUM)
           FROM @DBA.DB2_OBJ_SPACE_DTL B
           WHERE A.VCATNAME = B.VCATNAME
           AND A.DBNAME = B.DBNAME
           AND A.OBJ_NAME = B.OBJ_NAME
           AND A.OBJ_TYPE = B.OBJ_TYPE
           AND A.RPT_TMSTP = B.RPT_TMSTP)
AND DBNAME NOT LIKE 'D___DB07'
AND DBNAME NOT LIKE 'DSN8%'
AND DBNAME <> 'DSNDB07'
AND TRKS_ALLOC >= 17478
) A LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL  B
     ON A.DBNAME = B.DBNAME
     AND A.OBJ_NAME = B. OBJ_NAME
     AND A.DS_GRP = B.DS_GRP
     AND A.DSNUM = B. DSNUM
     AND B.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 7 DAYS
                         AND A.RPT_TMSTP + 5 HOURS- 7 DAYS
LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL  C
     ON A.DBNAME = C.DBNAME
     AND A.OBJ_NAME = C. OBJ_NAME
     AND A.DS_GRP = C.DS_GRP
     AND A.DSNUM = C. DSNUM
     AND C.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 14 DAYS
                         AND A.RPT_TMSTP + 5 HOURS - 14 DAYS
LEFT OUTER JOIN @DBA.DB2_OBJ_SPACE_DTL  D
     ON A.DBNAME = D.DBNAME
     AND A.OBJ_NAME = D. OBJ_NAME
     AND A.DS_GRP = D.DS_GRP
     AND A.DSNUM = D. DSNUM
     AND D.RPT_TMSTP BETWEEN A.RPT_TMSTP - 5 HOURS - 21 DAYS
                         AND A.RPT_TMSTP + 5 HOURS - 21 DAYS
  ORDER BY DS_GRP, TRKS_ALLOC DESC, TRKS_USED DESC
 WITH UR;
