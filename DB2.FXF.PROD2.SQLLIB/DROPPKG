-------------------------------------------------------------------
-- PACKAGE QUERY (MAX PACKAGE FOR A GIVEN COLLECTION)
-------------------------------------------------------------------
SELECT DISTINCT
       CHAR(' DROP PACKAGE '||STRIP(COLLID)||'.'||STRIP(NAME)||' ',80)
     , '1', PKG.COLLID, PKG.NAME, PKG.VERSION
  FROM SYSIBM.SYSPACKAGE PKG
     , SYSIBM.SYSPACKDEP DEP
WHERE DEP.DLOCATION = PKG.LOCATION
  AND DEP.DCOLLID = PKG.COLLID
  AND DEP.DNAME = PKG.NAME
  AND DEP.DCONTOKEN = PKG.CONTOKEN
  AND DEP.DTYPE = 'P'
  AND DEP.BTYPE = 'T'
  AND EXISTS (SELECT 'TRUE'
                FROM @DBA.OBSOLETE_DECOM_OBJECTS O
               WHERE O.CREATOR = DEP.BQUALIFIER
                 AND O.TABLE_NM = DEP.BNAME
                 AND O.DECOM_CHNG_NBR = 'CHG0374404')
   AND NOT EXISTS (SELECT 'TRUE'
                     FROM SYSIBM.SYSPKSYSTEM ENABLE
                    WHERE ENABLE.LOCATION = PKG.LOCATION
                      AND ENABLE.COLLID = PKG.COLLID
                      AND ENABLE.NAME = PKG.NAME
                      AND ENABLE.CONTOKEN = PKG.CONTOKEN
                      AND ENABLE = 'Y')

UNION ALL

SELECT DISTINCT CASE WHEN VERSION = ' ' THEN '      ;'
                ELSE CHAR('      VERSION "'||STRIP(VERSION)||'";',80)
                END CASE
     , '2', PKG.COLLID, PKG.NAME, PKG.VERSION
  FROM SYSIBM.SYSPACKAGE PKG
     , SYSIBM.SYSPACKDEP DEP
WHERE DEP.DLOCATION = PKG.LOCATION
  AND DEP.DCOLLID = PKG.COLLID
  AND DEP.DNAME = PKG.NAME
  AND DEP.DCONTOKEN = PKG.CONTOKEN
  AND DEP.DTYPE = 'P'
  AND DEP.BTYPE = 'T'
  AND EXISTS (SELECT 'TRUE'
                FROM @DBA.OBSOLETE_DECOM_OBJECTS O
               WHERE O.CREATOR = DEP.BQUALIFIER
                 AND O.TABLE_NM = DEP.BNAME
                 AND O.DECOM_CHNG_NBR = 'CHG0374404')
   AND NOT EXISTS (SELECT 'TRUE'
                     FROM SYSIBM.SYSPKSYSTEM ENABLE
                    WHERE ENABLE.LOCATION = PKG.LOCATION
                      AND ENABLE.COLLID = PKG.COLLID
                      AND ENABLE.NAME = PKG.NAME
                      AND ENABLE.CONTOKEN = PKG.CONTOKEN
                      AND ENABLE = 'Y')

ORDER BY 3, 4, 5, 2

 WITH UR;
